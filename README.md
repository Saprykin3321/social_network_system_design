# social_network_system_design
System Design education (may 2025)  
Проектирование высоконагруженной Социальной сети для путешественников

# Содержание
[1. Требования к системе](#Требования_к_системе)  
[2. Расчет нагрузки и трафика](#Расчет_нагрузки_и_трафика)  
[3. Модель данных](#Модель_данных)  
[4. Расчет объема хранилища на 1 год](#Расчет_хранилища)  
[5. Расчет количества дисков](#Расчет_дисков)  
[6. Расчет хостов](#Расчет_хостов)  
[7. Архитектура системы](#Архитектура)  

# Требования к системе <a name="Требования_к_системе"></a> 

## Функциональные требования:
1. Публикация постов
    1. Возможность прикрепить фотографии
    2. Возможность оставить описание
    3. Возможность оставить гео-метку
2. Оценка постов других пользователей
3. Комментарии постов других пользователей
4. Подписка на обновления других пользователей
5. Поиск популярных мест для путешествий
6. Просмотр постов
7. Просмотр ленты других пользователей в обратном хронологическом порядке
8. Просмотр своей ленты в обратном хронологическом порядке

## Нефункциональные требования
1. DAU – 10 000 000 в сутки
2. Только для стран СНГ
3. Система должна работать в мобильных устройствах и браузерах
4. Система должна быть надежной
5. Активность пользователей:
    1. Пользователи постят 2 поста в день с 1 фотографией
    2. Пользователи просматривают чужие и свою ленты 10 раз в день (1 лента = 10 постов)
    3. Пользователи оценивают 15 постов в день
    4. Пользователи оставляют 3 комментария в день
6. Требования к посту:
    1. Текст не более 2000 символов с возможностью указывать эмодзи
7. Требования к изображениям:
    1. Одно изображение должно весить не более 500 КБ
    2. В случае превышения размера необходимо сжимать изображение до 500 КБ
8. Сезонность:
    1. Лето
    2. Зима
9. Тайминги:
    1. Публикация одного поста - 2 секунды
    2. Получение ленты новостей - 2 секунды

---

# Расчет нагрузки и трафика <a name="Расчет_нагрузки_и_трафика"></a> 

## Нагрузка на запись
* **Посты**: RPS (write) = DAU * 2 поста в день / 86400 = 250 
* **Оценки**: RPS (write) = DAU * 15 оценок в день / 86400 = 1736
* **Комментарии**: RPS (write) = DAU * 3 комментария в день / 86400 = 347
* **Общая оценка**: 250 + 1736 + 347 ~ 2300

## Трафик на запись
* **Посты**: Traffic (write) = RPS * (4016 байт + 500 КБ) * 2 поста в день = 252 MB/s
* **Оценки**: Traffic (write) = RPS * 33 байт * 15 оценок = 860 KB/s
* **Комментарии**: Traffic (write) = RPS * 2032 байт * 3 коммента в день = 2 MB/s
* **Общая оценка**: 255 MB/s

## Нагрузка на чтение
* **Ленты постов**: RPS (read) = DAU * 100 постов / 86400 = 11574

## Трафик на чтение
* **Ленты постов**: Traffic (read) = RPS * (4016 байт (текст) + 500 КБ (картинка) + 2 байта (общие оценки) + 2 байта (общее кол-во комментов)) байт * 10 объектов = 58.3 GB/s

---

# Модель данных <a name="Модель_данных"></a> 

Модель данных доступна по ссылке

## Объем хранимых данных согласно модели
Один объект post занимает 4016 байт  
Один объект image занимает 92 байта  
Одно изображение занимает 500 КБ  
Одна оценка занимает 33 байта  
Один комментарий занимает 2032 байт  


<details>
  <summary>Подробности расчета</summary>
  
  **post**: 16 байт (ID) + 16 байт (User_ID) + 4000 байт (description с учетом смайликов и русскоязычных символов) + 8 байт (latitude) + 8 байт (longitude) + 8 байт (created_at) + 8 байт (updated_at) = 4064 байт  
  **image**: 16 байт (ID) + 16 байт (post_id) + 60 байт (image_url) = 92 байта  
  **review**: 16 байт (ID) + 16 байт (post_id) + 1 байт (grade) = 33 байта  
  **comment**: 16 байт (ID) + 16 байт (post_id) + 2000 байт (comment с учетом смайликов и русскоязычных смиволов) = 2032 байт  

</details>

post: 16 байт (ID) + 16 байт (User_ID) + 4000 байт (description с учетом смайликов и русскоязычных символов) + 8 байт (latitude) + 8 байт (longitude) + 8 байт (created_at) + 8 байт (updated_at) = 4064 байт
image: 16 байт (ID) + 16 байт (post_id) + 60 байт (image_url) = 92 байта
review: 16 байт (ID) + 16 байт (post_id) + 1 байт (grade) = 33 байта
comment: 16 байт (ID) + 16 байт (post_id) + 2000 байт (comment с учетом смайликов и русскоязычных смиволов) = 2032 байт

</spiler>

# Расчет объема хранилища на 1 год <a name="Расчет_хранилища"></a> 

## Расчет хранилища для изображений

* 1 фотография: 500 КБ
* В день один пользователь постит 2 фотографии: 500 КБ * 2 = 1 МБ
* В день для всех пользователей: DAU * 1 МБ = 10 ТБ
* В год для всех: 10 ТБ * 365 = 3.65 ПТ

Итого в год потребуется capacity: 3.65 ПТ

## Расчет хранилища для метаданных

**Посты**: 
* Один пост занимает 4016 байт
* В день пользователь публикует 2 поста: 4016 байт * 2 = 9032 байт
* В день для всех пользоателей: DAU * 9 КБ = 90 ГБ
* В год для всех: 90 ГБ * 365 = 32.8 ТБ

**Изображения**:
* Один изображение (мета) занимает 92 байта
* В день пользователь публикует 2 изображения: 92 байт * 2 = 184 байт
* В день для всех пользоателей: DAU * 184 байт = 1.8 ГБ
* В год для всех: 1.8 ГБ * 365 =  657 ГБ

**Оценки**:
* Одна оценка (мета) занимает 33 байта
* В день пользователь публикует 15 оценок: 33 байт * 15 = 495 байт
* В день для всех пользоателей: DAU * 184 байт = 4.9 ГБ
* В год для всех: 4.9 ГБ * 365 =  1.8 ТБ

**Комментарии**:
* Один комментарий (мета) занимает 2032 байта
* В день пользователь публикует 3 комментария: 2032 байт * 3 = 6.1 КБ
* В день для всех пользоателей: DAU * 184 байт = 61 ГБ
* В год для всех: 4.9 ГБ * 365 =  22 ТБ

Итого в год потребуется capacity: 57.2 ТБ

# Расчет количества дисков <a name="Расчет_дисков"></a> 

iops (сумм количество запросов в секунду): RPS(write) + RPS(read) = 2300 + 11574 = 13874  

HDD: 
* **Disks_for_capacity**: 57.2 ТБ / 16 ТБ = 4 диска  
* **Disks_for_iops**: 13874 / 100 (disk_iops) = 139 дисков  
* **Disks_for_throughput**: 58500 MB/s / 100 MB/s = 585 дисков  

Итого, если выбирать HDD, потребуется 585 дисков  

SSD:
* **Disks_for_capacity**: 57.2 ТБ / 16 ТБ = 4 диска  
* **Disks_for_iops**: 13874 / 1000 (disk_iops) = 14 дисков  
* **Disks_for_throughput**: 58500 MB/s / 500 MB/s = 118 дисков  

**Итого, если выбирать SSD, потребуется 118 дисков**

Для текущей системы предпочитительнее выбрать SSD

## Если хранить изображения в облаке

Для изображений на год потребуется 3.65 ПТ. Предположим, будем использовать Yandex S3 Cloud.  
Из расчета 2,1708 руб за ГБ (стандартное хранилище), получаем ~ 8 300 000 руб за год.

## Если хранить изображения на диске в BLOB-хранилище

HDD: 
* **Disks_for_capacity**: 3650 ТБ / 16 ТБ = 229 диска
* **Disks_for_iops**: 11824 / 100 (disk_iops) = 119 дисков
* **Disks_for_throughput**: 58500 MB/s / 100 MB/s = 585 дисков

Итого, если выбирать HDD, потребуется 585 дисков

SSD:
* **Disks_for_capacity**: 3650 ТБ / 16 ТБ = 229 дисков
* **Disks_for_iops**: 11824 / 1000 (disk_iops) = 12 дисков
* **Disks_for_throughput**: 58500 MB/s / 500 MB/s = 118 дисков

Итого, если выбирать HDD, потребуется 585 дисков

**Для удешивления системы предпочитительнее выбрать HDD** 

# Расчет хостов <a name="Расчет_хостов"></a> 

Для постов, комментариев и оценок можно выбрать реляционную БД PostgreSQL:
* Вид репликации async (задержки некритичны)
* Replication factor: 2
* Тип репликации master-slave
* В связи с большим количеством дисков потребуется шардирование: 2 disks by host = 59 disk * 2 = 118 hosts by 2 DISKs
* Шардирование key based way by user_id

Для изображений можно выбрать нереляционную БД MongoDB
* Вид репликации async (задержки некритичны)
* Replication factor: 2

# Архитектура системы <a name="Архитектура"></a> 

Диаграмма Context C4:

Диаграмма Containers C4: